<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments :: page_head(${pageTitle})"></head>

<body>

	<div class="container-fluid">
		<div th:replace="comm/navigation :: menu"></div>

		<div class="text-center">
			<h2>[[${pageTitle}]]</h2>
		</div>

		<form th:action="@{/products/save}" method="post"
			style="max-width: 500px; margin: 0 auto;" th:object="${product}"
			id="productForm" enctype="multipart/form-data">

			<input type="hidden" th:field="*{id}" />

			<div>
				<!-- Nav tabs -->
				<ul class="nav nav-tabs" id="myTab" role="tablist">
				  <li class="nav-item">
				    <a class="nav-link active" data-toggle="tab" href="#overview" role="tab" >Overview</a>
				  </li>
				  <li class="nav-item">
				    <a class="nav-link" data-toggle="tab" href="#pdescription" role="tab" >Description</a>
				  </li>
				  <li class="nav-item">
				    <a class="nav-link" data-toggle="tab" href="#images" role="tab">Images</a>
				  </li>
				  <li class="nav-item">
				    <a class="nav-link"  data-toggle="tab" href="#details" role="tab" >Detail</a>
				  </li>
				</ul>
				
				<!-- Tab panes -->
				<div class="tab-content">
				  <div class="tab-pane active" id="overview" role="tabpanel" >Overview</div>
				  <div class="tab-pane" id="description" role="tabpanel" >Description</div>
				  <div class="tab-pane" id="images" role="tabpanel" >Images</div>
				  <div class="tab-pane" id="details" role="tabpanel" >Details</div>
				</div>
			</div>
		</form>


		<!-- Modal -->
		<div th:replace="modal_fragments :: modal_dialog"></div>

		<!-- Footer -->

		<div th:replace="comm/footer :: footer"></div>
	</div>

	<!-- Load jQuery before other scripts -->
	<script th:src="@{/webjars/jquery/jquery.min.js}"></script>

	<script type="text/javascript">
      moduleURL = "[[@{/products}]]"; 
       
      $(document).ready(() => {
    	  // show cate in choose
    	    const dropdownCategories = $("#categories");
    	    const divChosenCategories = $("#chosenCategories");

    	    dropdownCategories.change(() => {
    	    	divChosenCategories.empty();
    	        showChosenCategories();
    	    });
    	    showChosenCategories();
    	    
    	    // check dulicateName
    	    $("#brandForm").submit(function(e) {
                e.preventDefault(); // Ngăn chặn form submit mặc định
                checkunique(this); // Gọi hàm checkUnique
            });
    	});

    	const showChosenCategories = () => {
    	    $("#categories option:selected").each(function() {
    	        const selectCategory = $(this);
    	        const catId = selectCategory.val();
    	        const catName = selectCategory.text().replace(/-/g, "");

    	        $("#chosenCategories").append("<span class='badge badge-secondary m-1'>"+catName+"</span>");
    	    });
    	};

    	function checkunique(form) {
    		url = "[[@{/products/check_unique}]]";
    		brandId = $("#id").val();
    		brandName = $("#name").val();
    		
    		csrfValue = $("input[name='_csrf']").val(); // Lấy giá trị CSRF token từ input ẩn
            params = {
                id : brandId,
                name : brandName,
                _csrf : csrfValue
            }; 
            $.post(
                url,
                params,
                function(response) { // Thực hiện POST request
                    if (response == "OK") {
                        form.submit();
                    } else if (response == "Duplicate") {
                        showModalDialog("Warning",
                                "There is another Brand having same name  "
                                        + brandName); // Hiển thị phản hồi từ server
                    } else {
                        showModalDialog("Error",
                                "Unknow response from server");
                    } 
                    
                }).fail(function() { // khi sai đường dẫn
             	   showErrorModal("Could not connect to the server"); 
           });

            return false; // Ngăn form submit mặc định
        }

    

    </script>

	<script th:src="@{/js/comm.js}"></script>
	<script th:src="@{/js/navigationJS.js}"></script>
	<script th:src="@{/js/comm_form.js}"></script>
</body>
</html>
