<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments :: page_head(${pageTitle}, 'none')"></head>

<body>

	<div class="container-fluid">
		<div th:replace="comm/navigation :: menu"></div>

		<div class="text-center">
			<h2>[[${pageTitle}]]</h2>
		</div>

		<form th:action="@{/brands/save}" method="post"
			style="max-width: 500px; margin: 0 auto;" th:object="${brand}"
			id="brandForm" enctype="multipart/form-data">

			<input type="hidden" th:field="*{id}" />

			<div class="border border-secondary rounded p-3">
				<div class="form-group row">
					<label class="col-sm-4">brand name :</label>
					<div class="col-sm-8">
						<input type="text" class="form-control" th:field="*{name}"
							required minlength="3" maxlength="128" />
					</div>
				</div>


				<div class="form-group row">
					<label class="col-sm-4">Brand Logo : </label>
					<div class="col-sm-8">
						<input type="hidden" th:field="*{logo}"> <input
							type="file" id="fileImage" name="fileImage"
							accept="image/png , image/jpeg" class="mb-2"
							th:required="${brand.id  == null}" />

						<div class="mt-2">
							<img id="thumbnail" alt="Logo preview" class="img-cluid"
								th:src="@{${brand.logoPath}}" />
						</div>
					</div>
				</div>

				<div class="form-group row">
					<label class="col-sm-4">Select one or more categories </label>
					<div class="col-sm-8">
						<select class="form-control" th:field="*{categories}" multiple
							required style="resize: vertical;">
							<th:block th:each="cat : ${listCategories}">
								<option th:value="${cat.id}">[[${cat.name}]]</option>
							</th:block>
						</select>

					</div>
				</div>

				<div class="form-group row">
					<label class="col-sm-4">Chosen Categories </label>
					<div id="chosenCategories" class="col-sm-8"></div>
				</div>


				<div class="form-group row">
					<label class="col-sm-4"></label>
					<div class="col-sm-8">
						<input type="submit" value="Save" class="btn btn-primary m-3" />
						<input type="button" value="Cancel" class="btn btn-secondary"
							id="btnCancel" />
					</div>
				</div>
			</div>
		</form>


		<!-- Modal -->
		<div th:replace="modal_fragments :: modal_dialog"></div>

		<!-- Footer -->

		<div th:replace="comm/footer :: footer"></div>
	</div>

	<!-- Load jQuery before other scripts -->
	<script th:src="@{/webjars/jquery/jquery.min.js}"></script>

	<script type="text/javascript">
	MAX_FILE_SIZE = 102400;
      moduleURL = "[[@{/brands}]]"; 
       
      $(document).ready(() => {
    	  // show cate in choose
    	    const dropdownCategories = $("#categories");
    	    const divChosenCategories = $("#chosenCategories");

    	    dropdownCategories.change(() => {
    	    	divChosenCategories.empty();
    	        showChosenCategories();
    	    });
    	    showChosenCategories();
    	    
    	    // check dulicateName
    	    $("#brandForm").submit(function(e) {
                e.preventDefault(); // Ngăn chặn form submit mặc định
                checkunique(this); // Gọi hàm checkUnique
            });
    	});

    	const showChosenCategories = () => {
    	    $("#categories option:selected").each(function() {
    	        const selectCategory = $(this);
    	        const catId = selectCategory.val();
    	        const catName = selectCategory.text().replace(/-/g, "");

    	        $("#chosenCategories").append("<span class='badge badge-secondary m-1'>"+catName+"</span>");
    	    });
    	};

    	function checkunique(form) {
    		url = "[[@{/brands/check_unique}]]";
    		brandId = $("#id").val();
    		brandName = $("#name").val();
    		
    		csrfValue = $("input[name='_csrf']").val(); // Lấy giá trị CSRF token từ input ẩn
            params = {
                id : brandId,
                name : brandName,
                _csrf : csrfValue
            }; 
            $.post(
                url,
                params,
                function(response) { // Thực hiện POST request
                    if (response == "OK") {
                        form.submit();
                    } else if (response == "Duplicate") {
                        showModalDialog("Warning",
                                "There is another Brand having same name  "
                                        + brandName); // Hiển thị phản hồi từ server
                    } else {
                        showModalDialog("Error",
                                "Unknow response from server");
                    } 
                    
                }).fail(function() { // khi sai đường dẫn
             	   showErrorModal("Could not connect to the server"); 
           });

            return false; // Ngăn form submit mặc định
        }

    

    </script>

	<script th:src="@{/js/comm.js}"></script>
	<script th:src="@{/js/navigationJS.js}"></script>
	<script th:src="@{/js/comm_form.js}"></script>
</body>
</html>
